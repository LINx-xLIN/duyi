### 阻止跳转

1. #### 准备基础组件： 使用到上节课中的动画路由组件

    ```jsx
    import "./Pages.css";
    import React from "react";
    import { NavLink, withRouter } from "react-router-dom";
    
    export function NavBar() {
      return (
        <div className="header">
          <NavLink to="/" exact>首页</NavLink>
          <NavLink to="/news" exact>新闻页</NavLink>
        </div>
      );
    }
    
    function Home() {
      return (
        <div className="page home">
          <h1>首页</h1>
          <p>
            Lorem ipsum dolor sit amet consectetur, adipisicing elit. Tempora,
            dignissimos tenetur. Reprehenderit eum quod itaque repudiandae,
            perspiciatis nam inventore asperiores.
          </p>
        </div>
      );
    }
    
    class News extends React.Component {
      state = {
        val: "",
      };
      render() {
        return (
          <div className="page news">
            <h1>新闻页</h1>
            <textarea
              value={this.state.val}
              onChange={(e) => {
                this.setState({
                  ...this.state,
                  val: e.target.value,
                });
              }}
            ></textarea>
          </div>
        );
      }
    }
    export const HomePage = Home;
    export const NewsPage = withRouter(News);
    
    ```

    ```jsx
    import React from "react";
    import * as Pages from "./pages/Pages";
    import { BrowserRouter as Router } from "react-router-dom";
    import "./App.css";
    import TransitionRoute from "./components/TransitionRoute";
    
    export default function App() {
      return (
        <Router>
          <Pages.NavBar />
          <div className="page-container">
            <TransitionRoute path="/" exact component={Pages.HomePage} />
            <TransitionRoute path="/news" exact component={Pages.NewsPage} />
          </div>
        </Router>
      );
    }
    ```

2. #### 需求：当表单域有内容，如果跳转页面到首页，表单域的内容会丢失，所以需要设置阻塞，提示用户是否跳转

3. #### 新闻页组件添加阻塞

    1. 新闻页设置阻塞消息: 如果文本内容有值且当前没有阻塞，添加阻塞

        ```jsx
        ...
        class News extends React.Component {
          state = {
            val: "",
          };
        
          componentWillUnmount() {
            // 取消阻塞
            if (this.unBlock) {
              this.unBlock();
            }
          }
        
          handleBlock = (value) => {
            if (value && !this.unBlock) {
              // 如果文本内容有值且当前没有阻塞，添加阻塞
              this.unBlock = this.props.history.block(() => {
                return "页面跳转，文本内容会消失，真的要调转吗？";
              });
            } else if (!value && this.unBlock) {
              // 取消阻塞
              this.unBlock();
              this.unBlock = null;
            }
          };
        
          render() {
            return (
              <div className="page news">
                <h1>新闻页</h1>
                <textarea
                  value={this.state.val}
                  onChange={(e) => {
                    this.setState({
                      ...this.state,
                      val: e.target.value,
                    });
                    this.handleBlock(e.target.value);
                  }}
                ></textarea>
              </div>
            );
          }
        }
        
        export const HomePage = Home;
        export const NewsPage = withRouter(News);
        ```

    2.  主页:  路由根组件设置阻塞开关

        ```jsx
        import React from "react";
        import { BrowserRouter as Router } from "react-router-dom";
        import * as Pages from "./pages/Pages";
        import TransitionRoute from "./components/TransitionRoute";
        import "./App.css";
        
        export default function App() {
          return (
            <Router
              getUserConfirmation={(msg, callback) => {
                callback(window.confirm(msg));
              }}
            >
              <Pages.NavBar />
              <div className="page-container">
                <TransitionRoute path="/" exact component={Pages.HomePage} />
                <TransitionRoute path="/news" exact component={Pages.NewsPage} />
              </div>
            </Router>
          );
        }
        ```
        

4. #### 封装通用的阻塞组件Prompt

    1. 将设置阻塞的功能部分代码，抽离封装成一个通用的组件

        ```jsx
        import { Component } from "react";
        import { withRouter } from "react-router-dom";
        
        class Prompt extends Component {
          static defaultProps = {
            when: false, // when为ture时，设置阻塞
            message: "", // 阻塞弹窗显示的消息
          };
        
          componentDidMount() {
            this.handleBlock();
          }
          componentDidUpdate() {
            this.handleBlock();
          }
          componentWillUnmount() {
            // 取消阻塞
            if (this.unBlock) {
              this.unBlock();
            }
          }
          handleBlock = () => {
            if (this.props.when && !this.unBlock) {
              // 如果文本内容有值且当前没有阻塞，添加阻塞
              this.unBlock = this.props.history.block(() => {
                return this.props.message;
              });
            } else if (!this.props.when && this.unBlock) {
              // 取消阻塞
              this.unBlock();
              this.unBlock = null;
            }
          };
          render() {
            return null;
          }
        }
        export default withRouter(Prompt);
        
        ```

    2. 组件使用阻塞组件Prompt

        ```jsx
        ...
        import Prompt from "../components/Prompt";
        ...
        class News extends React.Component {
          state = {
            val: "",
          };
        
          render() {
            return (
              <div className="page news">
                <h1>新闻页</h1>
                <Prompt
                  when={this.state.val !== ""}
                  message={"页面跳转，文本内容会消失，真的要调转吗？"}
                />
                <textarea
                  value={this.state.val}
                  onChange={(e) => {
                    this.setState({
                      ...this.state,
                      val: e.target.value,
                    });
                  }}
                ></textarea>
              </div>
            );
          }
        }
        
        export const HomePage = Home;
        export const NewsPage = withRouter(News);
        
        ```
        
        

5. #### 直接使用react-router-dom已经封装好的阻塞组件Prompt

    1. react-router-dom已经封装了阻塞组件Prompt

        ```jsx
        import "./Pages.css";
        import React from "react";
        import { NavLink, withRouter, Prompt } from "react-router-dom";
        
        export function NavBar() {
          return (
            <div className="header">
              <NavLink to="/" exact>
                首页
              </NavLink>
              <NavLink to="/news" exact>
                新闻页
              </NavLink>
            </div>
          );
        }
        
        function Home() {
          return (
            <div className="page home">
              <h1>首页</h1>
              <p>
                Lorem ipsum dolor sit amet consectetur, adipisicing elit. Tempora,
                dignissimos tenetur. Reprehenderit eum quod itaque repudiandae,
                perspiciatis nam inventore asperiores.
              </p>
            </div>
          );
        }
        
        class News extends React.Component {
          state = {
            val: "",
          };
        
          render() {
            return (
              <div className="page news">
                <h1>新闻页</h1>
                <Prompt
                  when={this.state.val !== ""}
                  message={"页面跳转，文本内容会消失，真的要调转吗？"}
                />
                <textarea
                  value={this.state.val}
                  onChange={(e) => {
                    this.setState({
                      ...this.state,
                      val: e.target.value,
                    });
                  }}
                ></textarea>
              </div>
            );
          }
        }
        
        export const HomePage = Home;
        export const NewsPage = withRouter(News);
        ```
    
